<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Indiagram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Grand+Hotel&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; background: #fafafa; } 
        .font-insta { font-family: 'Grand Hotel', cursive; }
        .modal-animate { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, updateDoc, collection, query, where, getDocs, addDoc, serverTimestamp, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBIWFvOKLOpOFfik5YmsERR9pVLjs7tYTc", authDomain: "make-a-site.firebaseapp.com", projectId: "make-a-site", storageBucket: "make-a-site.firebasestorage.app", messagingSenderId: "1099071295300", appId: "1:1099071295300:web:c5e997a1591b9ffee55111" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function Navbar() {
            return (
                <nav className="bg-white border-b h-16 flex items-center justify-between px-4 sticky top-0 z-50">
                    <h1 className="font-insta text-3xl cursor-pointer bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-orange-500" onClick={()=>window.location.href='home.html'}>Indiagram</h1>
                    <div className="flex gap-4 items-center">
                        <a href="home.html" className="material-icons-round text-3xl text-slate-600 hover:text-black">home</a>
                        <a href="search.html" className="material-icons-round text-3xl text-slate-600 hover:text-black">search</a>
                        <a href="message-list.html" className="material-icons-round text-3xl text-slate-600 hover:text-black">chat</a>
                        <a href="notifications.html" className="material-icons-round text-3xl text-slate-600 hover:text-black">favorite_border</a>
                        <a href="profile.html" className="material-icons-round text-3xl text-black">account_circle</a>
                    </div>
                </nav>
            );
        }

        function UserListModal({ title, users, onClose }) {
            return (
                <div className="fixed inset-0 z-[70] bg-black/60 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl w-full max-w-sm max-h-[70vh] flex flex-col modal-animate overflow-hidden">
                        <div className="p-3 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold">{title}</h3>
                            <button onClick={onClose}><span className="material-icons-round">close</span></button>
                        </div>
                        <div className="overflow-y-auto p-2">
                            {users.length === 0 ? <p className="text-center p-4 text-slate-500">List is empty.</p> : 
                             users.map(u => (
                                <div key={u.uid} className="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-lg cursor-pointer" onClick={()=>window.location.href=`profile.html?uid=${u.uid}`}>
                                    <img src={u.photoURL || "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png"} className="w-10 h-10 rounded-full bg-slate-200 object-cover border" />
                                    <div>
                                        <p className="font-bold text-sm flex items-center gap-1">{u.username} {u.isVerified && <span className="material-icons-round text-blue-500 text-sm">verified</span>}</p>
                                        <p className="text-xs text-slate-500">{u.name}</p>
                                    </div>
                                </div>
                             ))
                            }
                        </div>
                    </div>
                </div>
            );
        }

        function EditProfileModal({ user, onClose }) {
            const [name, setName] = React.useState(user.name);
            const [username, setUsername] = React.useState(user.username);
            const [bio, setBio] = React.useState(user.bio || '');
            const [photo, setPhoto] = React.useState(user.photoURL || '');
            const fileRef = React.useRef();

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => setPhoto(reader.result);
                    reader.readAsDataURL(file);
                }
            };
            
            const handleSave = async () => {
                try {
                    let changeCount = user.usernameChangeCount || 0;
                    if (username !== user.username) {
                        changeCount += 1;
                    }

                    await updateDoc(doc(db, "users", user.uid), { 
                        name, 
                        username, 
                        bio, 
                        photoURL: photo,
                        usernameChangeCount: changeCount 
                    });
                    
                    if(auth.currentUser) await updateProfile(auth.currentUser, { displayName: name, photoURL: photo });
                    alert("Profile Saved!");
                    onClose();
                } catch(e) { alert("Error saving: " + e.message); }
            };

            const handleDeleteAccount = async () => {
                if(confirm("ARE YOU SURE? This will permanently delete your account and cannot be undone.")) {
                    try {
                        const uid = user.uid;
                        await deleteDoc(doc(db, "users", uid));
                        await deleteUser(auth.currentUser);
                        alert("Account Deleted.");
                        window.location.href = "index.html";
                    } catch(e) {
                        alert("Error: Please log out and log in again to perform this security sensitive action.");
                    }
                }
            }

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]">
                    <div className="bg-white p-6 rounded-xl w-96 max-h-[90vh] overflow-y-auto modal-animate">
                        <h3 className="font-bold mb-4 text-xl">Edit Profile</h3>
                        <div className="flex flex-col items-center mb-4">
                            <img src={photo || "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png"} className="w-20 h-20 rounded-full object-cover border mb-2" />
                            <button onClick={()=>fileRef.current.click()} className="text-blue-500 font-bold text-sm">Change Profile Photo</button>
                            <input type="file" ref={fileRef} hidden accept="image/*" onChange={handleFile} />
                        </div>
                        <label className="text-xs text-slate-500 font-bold">Name</label>
                        <input className="w-full border p-2 mb-3 rounded" value={name} onChange={e=>setName(e.target.value)} />
                        <label className="text-xs text-slate-500 font-bold">Username</label>
                        <input className="w-full border p-2 mb-3 rounded" value={username} onChange={e=>setUsername(e.target.value)} />
                        <label className="text-xs text-slate-500 font-bold">Bio</label>
                        <textarea className="w-full border p-2 mb-4 rounded" rows="3" value={bio} onChange={e=>setBio(e.target.value)}></textarea>
                        <div className="flex gap-2 mb-6 border-b pb-6">
                            <button onClick={handleSave} className="bg-blue-500 text-white px-4 py-2 rounded flex-1 font-bold">Save</button>
                            <button onClick={onClose} className="bg-slate-200 px-4 py-2 rounded flex-1 font-bold">Cancel</button>
                        </div>
                        <button onClick={handleDeleteAccount} className="w-full text-red-500 text-sm font-bold border border-red-100 py-3 rounded bg-red-50 hover:bg-red-100">Delete Account Permanently</button>
                    </div>
                </div>
            );
        }

        function ProfilePage() {
            const [currentUser, setCurrentUser] = React.useState(null);
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [profileUser, setProfileUser] = React.useState(null);
            const [posts, setPosts] = React.useState([]);
            const [isEditing, setIsEditing] = React.useState(false);
            const [showMenu, setShowMenu] = React.useState(false);
            const [isFollowing, setIsFollowing] = React.useState(false);
            const [followersCount, setFollowersCount] = React.useState(0);
            const [followingCount, setFollowingCount] = React.useState(0);
            const [showListModal, setShowListModal] = React.useState(false);
            const [listTitle, setListTitle] = React.useState('');
            const [listUsers, setListUsers] = React.useState([]);

            const urlParams = new URLSearchParams(window.location.search);
            const targetUid = urlParams.get('uid');

            React.useEffect(() => {
                onAuthStateChanged(auth, async (u) => {
                    if(!u) return window.location.href = "index.html";
                    setCurrentUser(u);
                    
                    const myDoc = await getDoc(doc(db, "users", u.uid));
                    if(myDoc.exists() && myDoc.data().username === 'admin') setIsAdmin(true);

                    const uidToLoad = targetUid || u.uid;
                    
                    const unsubUser = onSnapshot(doc(db, "users", uidToLoad), async (d) => {
                        if(d.exists()) {
                            setProfileUser(d.data());
                        } else {
                            if (uidToLoad === u.uid) {
                                // AUTO FIX
                                const autoUser = {
                                    uid: u.uid,
                                    name: u.displayName || "User",
                                    username: u.email ? u.email.split('@')[0] : "user" + Math.floor(Math.random()*1000),
                                    email: u.email,
                                    photoURL: u.photoURL || "",
                                    bio: "",
                                    country: "India",
                                    isVerified: false,
                                    isBanned: false,
                                    createdAt: serverTimestamp()
                                };
                                await setDoc(doc(db, "users", u.uid), autoUser);
                            } else {
                                setProfileUser({ name: "User Not Found", username: "unknown", bio: "Account not found.", isVerified: false });
                            }
                        }
                    });

                    const q = query(collection(db, "posts"), where("userId", "==", uidToLoad));
                    const unsubPosts = onSnapshot(q, (s) => {
                        setPosts(s.docs.map(d => d.data()));
                    });

                    if (u.uid !== uidToLoad) {
                        const qFollow = query(collection(db, "follows"), where("followerId", "==", u.uid), where("followingId", "==", uidToLoad));
                        onSnapshot(qFollow, snap => setIsFollowing(!snap.empty));
                    }

                    const qFollowers = query(collection(db, "follows"), where("followingId", "==", uidToLoad));
                    onSnapshot(qFollowers, snap => setFollowersCount(snap.size));

                    const qFollowing = query(collection(db, "follows"), where("followerId", "==", uidToLoad));
                    onSnapshot(qFollowing, snap => setFollowingCount(snap.size));

                    return () => { unsubUser(); unsubPosts(); };
                });
            }, [targetUid]);

            const handleFollow = async () => {
                await addDoc(collection(db, "follows"), {
                    followerId: currentUser.uid,
                    followingId: profileUser.uid,
                    timestamp: serverTimestamp()
                });
                
                // Add Notification for Follow
                await addDoc(collection(db, "notifications"), {
                    to: profileUser.uid,
                    from: currentUser.uid,
                    type: 'follow',
                    content: '',
                    timestamp: serverTimestamp()
                });
            };

            const handleUnfollow = async () => {
                const q = query(collection(db, "follows"), where("followerId", "==", currentUser.uid), where("followingId", "==", profileUser.uid));
                const snap = await getDocs(q);
                snap.forEach(d => deleteDoc(d.ref));
            };

            const openList = async (type) => {
                setListTitle(type === 'followers' ? 'Followers' : 'Following');
                setListUsers([]); 
                setShowListModal(true);
                const field = type === 'followers' ? 'followingId' : 'followerId'; 
                const targetField = type === 'followers' ? 'followerId' : 'followingId'; 
                const q = query(collection(db, "follows"), where(field, "==", profileUser.uid));
                const snap = await getDocs(q);
                const userIds = snap.docs.map(d => d.data()[targetField]);
                if (userIds.length > 0) {
                    const userDocs = await Promise.all(userIds.map(id => getDoc(doc(db, "users", id))));
                    setListUsers(userDocs.map(d => d.data()));
                }
            };

            // --- ADMIN ACTION (VERIFY) ---
            const toggleVerify = async () => {
                if(!isAdmin) return;
                const newStatus = !profileUser.isVerified;
                await updateDoc(doc(db, "users", profileUser.uid), { 
                    isVerified: newStatus,
                    verifiedAt: newStatus ? serverTimestamp() : null
                });

                // SEND SYSTEM NOTIFICATION IF GIVING BLUE TICK
                if (newStatus === true) {
                    await addDoc(collection(db, "notifications"), {
                        to: profileUser.uid,
                        from: 'admin', // or currentUser.uid
                        type: 'system_verify',
                        content: '',
                        timestamp: serverTimestamp()
                    });
                }
            };

            const toggleBan = async () => {
                if(!isAdmin) return;
                await updateDoc(doc(db, "users", profileUser.uid), { isBanned: !profileUser.isBanned });
            };

            const handleBlock = async () => {
                alert(`Blocked ${profileUser.username}`);
                setShowMenu(false);
            };

            const handleAbout = () => {
                const joinDate = profileUser.createdAt ? new Date(profileUser.createdAt.seconds * 1000).toLocaleDateString('en-IN', {day:'numeric', month:'long', year:'numeric'}) : 'N/A';
                let verifiedInfo = "Not Verified";
                if(profileUser.isVerified) {
                    if(profileUser.verifiedAt) {
                        verifiedInfo = new Date(profileUser.verifiedAt.seconds * 1000).toLocaleDateString('en-IN', {day:'numeric', month:'long', year:'numeric'});
                    } else {
                        verifiedInfo = "Verified recently";
                    }
                }
                let formerNamesInfo = "";
                if (profileUser.usernameChangeCount && profileUser.usernameChangeCount > 0) {
                    formerNamesInfo = `\nFormer Usernames: ${profileUser.usernameChangeCount}`;
                }
                alert(`About this account:\n\nJoined: ${joinDate}\nCountry: ${profileUser.country || 'India'}\nVerified On: ${verifiedInfo}${formerNamesInfo}`);
                setShowMenu(false);
            };

            if(!profileUser || !currentUser) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;

            const isMe = currentUser.uid === profileUser.uid;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <Navbar />
                    {isEditing && <EditProfileModal user={profileUser} onClose={()=>setIsEditing(false)} />}
                    {showListModal && <UserListModal title={listTitle} users={listUsers} onClose={()=>setShowListModal(false)} />}
                    
                    <div className="flex-1 max-w-4xl mx-auto w-full p-4 relative">
                        <div className="absolute top-6 right-6 z-10">
                            <button onClick={()=>setShowMenu(!showMenu)}><span className="material-icons-round text-2xl">more_horiz</span></button>
                            {showMenu && (
                                <div className="absolute right-0 top-8 bg-white border shadow-lg rounded-lg w-52 py-2 z-20">
                                    <button onClick={handleAbout} className="w-full text-left px-4 py-2 hover:bg-slate-50 text-sm flex items-center gap-2">
                                        <span className="material-icons-round text-base">info</span> About this account
                                    </button>
                                    {!isMe && <button onClick={handleBlock} className="w-full text-left px-4 py-2 hover:bg-slate-50 text-sm text-red-500 font-bold">Block</button>}
                                </div>
                            )}
                        </div>

                        <div className="bg-white rounded-xl border p-6 mb-4 flex flex-col md:flex-row items-center md:items-start gap-6">
                            <img src={profileUser.photoURL || "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png"} className="w-24 h-24 rounded-full border p-1 object-cover" />
                            <div className="flex-1 text-center md:text-left w-full">
                                <h2 className="text-2xl font-light flex items-center justify-center md:justify-start gap-2">
                                    {profileUser.username}
                                    {profileUser.isVerified && <span className="material-icons-round text-blue-500">verified</span>}
                                </h2>
                                
                                <div className="flex justify-center md:justify-start gap-2 mt-3 mb-4">
                                    {isMe ? (
                                        <>
                                            <button onClick={()=>setIsEditing(true)} className="bg-slate-100 px-4 py-1.5 rounded font-bold text-sm">Edit Profile</button>
                                            <button onClick={()=>signOut(auth).then(()=>window.location.href='index.html')} className="bg-slate-100 px-4 py-1.5 rounded font-bold text-sm text-red-500">Logout</button>
                                        </>
                                    ) : (
                                        <>
                                            {isFollowing ? (
                                                <button onClick={handleUnfollow} className="bg-slate-200 text-black px-6 py-1.5 rounded font-bold text-sm">Following</button>
                                            ) : (
                                                <button onClick={handleFollow} className="bg-blue-500 text-white px-6 py-1.5 rounded font-bold text-sm">Follow</button>
                                            )}
                                            <button onClick={()=>window.location.href=`message-list.html?chatWith=${profileUser.uid}`} className="bg-slate-100 px-6 py-1.5 rounded font-bold text-sm">Message</button>
                                        </>
                                    )}
                                </div>

                                <p className="font-bold">{profileUser.name}</p>
                                <p className="text-sm text-slate-600 mb-4">{profileUser.bio || "No bio yet."}</p>
                                
                                <div className="flex justify-center md:justify-start gap-8 border-t md:border-t-0 pt-4 md:pt-0 cursor-pointer">
                                    <span><b>{posts.length}</b> posts</span>
                                    <span onClick={()=>openList('followers')}><b>{followersCount}</b> followers</span>
                                    <span onClick={()=>openList('following')}><b>{followingCount}</b> following</span>
                                </div>
                            </div>
                        </div>

                        {isAdmin && (
                            <div className="bg-slate-800 text-white p-4 rounded-xl mb-6 shadow-lg">
                                <h3 className="font-bold text-yellow-400 mb-2 flex items-center gap-2">
                                    <span className="material-icons-round">admin_panel_settings</span> Admin Controls
                                </h3>
                                <div className="flex gap-4">
                                    <button onClick={toggleVerify} className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-bold flex-1">
                                        {profileUser.isVerified ? "Remove Blue Tick" : "Give Blue Tick"}
                                    </button>
                                    <button onClick={toggleBan} className={`${profileUser.isBanned ? 'bg-green-600' : 'bg-red-600'} hover:opacity-90 px-4 py-2 rounded text-sm font-bold flex-1`}>
                                        {profileUser.isBanned ? "Enable User" : "Ban User"}
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-3 gap-1 md:gap-4">
                            {posts.map((p, i) => (
                                <div key={i} className="aspect-square bg-slate-200 relative group overflow-hidden">
                                    <img src={p.imageUrl} className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white font-bold gap-1">
                                        <span className="material-icons-round text-sm">favorite</span> {p.likes?.length}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProfilePage />);
    </script>
</body>
</html>