<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Grand+Hotel&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; background: #fafafa; } .font-insta { font-family: 'Grand Hotel', cursive; } </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Added signOut here
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, getDoc, updateDoc, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBIWFvOKLOpOFfik5YmsERR9pVLjs7tYTc", authDomain: "make-a-site.firebaseapp.com", projectId: "make-a-site", storageBucket: "make-a-site.firebasestorage.app", messagingSenderId: "1099071295300", appId: "1:1099071295300:web:c5e997a1591b9ffee55111" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const formatRelativeTime = (timestamp) => {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp.seconds * 1000);
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return `${diff}s`;
            if (diff < 3600) return `${Math.floor(diff/60)}m`;
            if (diff < 86400) return `${Math.floor(diff/3600)}h`;
            if (diff < 604800) return `${Math.floor(diff/86400)}d`;
            return `${Math.floor(diff/604800)}w`;
        };

        function Navbar() {
            return (
                <nav className="bg-white border-b h-16 flex items-center justify-between px-4 sticky top-0 z-50">
                    <h1 className="font-insta text-3xl cursor-pointer bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-orange-500" onClick={()=>window.location.href='home.html'}>Indiagram</h1>
                    <div className="flex gap-4 items-center">
                        <a href="home.html" className="material-icons-round text-3xl text-slate-600 hover:text-black">home</a>
                        <a href="search.html" className="material-icons-round text-3xl text-slate-600 hover:text-black">search</a>
                        <a href="message-list.html" className="material-icons-round text-3xl text-slate-600 hover:text-black">chat</a>
                        <a href="notifications.html" className="material-icons-round text-3xl text-black">favorite</a>
                        <a href="profile.html" className="material-icons-round text-3xl text-slate-600 hover:text-black">account_circle</a>
                    </div>
                </nav>
            );
        }

        function NotificationItem({ n, currentUser }) {
            const [sender, setSender] = React.useState(null);
            const [isFollowing, setIsFollowing] = React.useState(false);
            const [showReply, setShowReply] = React.useState(false);
            const [replyText, setReplyText] = React.useState('');
            const [isLiked, setIsLiked] = React.useState(false);

            React.useEffect(() => {
                if (n.type === 'system_verify') return;
                const unsubSender = onSnapshot(doc(db, "users", n.from), (docSnap) => {
                    if (docSnap.exists()) setSender(docSnap.data());
                });
                
                const qFollow = query(collection(db, "follows"), where("followerId", "==", currentUser.uid), where("followingId", "==", n.from));
                const unsubFollow = onSnapshot(qFollow, snap => setIsFollowing(!snap.empty));

                return () => { unsubSender(); unsubFollow(); };
            }, [n.from, n.type, currentUser.uid]);

            const handleFollowBack = async (e) => {
                e.stopPropagation();
                await addDoc(collection(db, "follows"), { followerId: currentUser.uid, followingId: n.from, timestamp: serverTimestamp() });
                await addDoc(collection(db, "notifications"), { to: n.from, from: currentUser.uid, type: 'follow', content: '', timestamp: serverTimestamp() });
            };

            const handleMessage = (e) => {
                e.stopPropagation();
                window.location.href = `message-list.html?chatWith=${n.from}`;
            };

            const handleReply = async (e) => {
                e.preventDefault();
                if(!replyText.trim() || !n.postId) return;
                
                const postRef = doc(db, "posts", n.postId);
                const postSnap = await getDoc(postRef);
                if(postSnap.exists()) {
                    const comments = postSnap.data().comments || [];
                    const newComment = {
                        id: Date.now().toString(), userId: currentUser.uid, username: currentUser.displayName || "User", text: replyText, timestamp: Date.now()
                    };
                    await updateDoc(postRef, { comments: [...comments, newComment] });
                    alert("Reply sent!");
                    setReplyText('');
                    setShowReply(false);
                }
            };

            const toggleCommentLike = (e) => {
                e.stopPropagation();
                setIsLiked(!isLiked); 
            };

            // SYSTEM NOTIFICATION
            if (n.type === 'system_verify') {
                return (
                    <div className="flex items-start gap-3 p-3 border-b hover:bg-slate-50">
                        <div className="w-10 h-10 rounded-full border flex items-center justify-center bg-white shrink-0 mt-1">
                            <span className="material-icons-round text-xl text-blue-500">verified</span>
                        </div>
                        <div className="text-sm flex-1">
                            <span className="block leading-snug">{n.content}</span>
                            <span className="text-xs text-slate-400 mt-1 block">{formatRelativeTime(n.timestamp)}</span>
                        </div>
                    </div>
                );
            }

            if (!sender) return null; 

            return (
                <div className="flex items-center gap-3 p-3 border-b hover:bg-slate-50 relative group">
                    <img onClick={() => window.location.href=`profile.html?uid=${sender.uid}`} src={sender.photoURL || "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png"} className="w-10 h-10 rounded-full object-cover border shrink-0 cursor-pointer" />
                    
                    <div className="flex-1 text-sm">
                        <div className="flex justify-between items-start">
                            <div className="pr-4 flex-1">
                                <span onClick={() => window.location.href=`profile.html?uid=${sender.uid}`} className="font-bold mr-1 inline-flex items-center gap-1 cursor-pointer">
                                    {sender.username}
                                    {sender.isVerified && <span className="material-icons-round text-blue-500 text-[10px]">verified</span>}
                                </span>
                                <span>
                                    {n.type === 'like' && 'liked your post.'}
                                    {n.type === 'comment' && `commented: "${n.content}"`}
                                    {n.type === 'follow' && 'started following you.'}
                                </span>
                                <span className="text-xs text-slate-400 ml-2">{formatRelativeTime(n.timestamp)}</span>
                                
                                {/* ACTIONS ROW */}
                                {n.type === 'comment' && (
                                    <div className="flex items-center gap-4 mt-1.5">
                                        <button onClick={()=>setShowReply(!showReply)} className="text-xs text-slate-500 font-semibold hover:text-black">Reply</button>
                                        <button onClick={toggleCommentLike} className={`text-xs ${isLiked ? 'text-red-500' : 'text-slate-400'} flex items-center`}>
                                            <span className="material-icons-round text-xs mr-0.5">{isLiked ? 'favorite' : 'favorite_border'}</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            {/* RIGHT SIDE */}
                            <div className="shrink-0 ml-2">
                                {n.type === 'follow' ? (
                                    isFollowing ? (
                                        <button onClick={handleMessage} className="bg-slate-100 text-black px-4 py-1.5 rounded-lg text-sm font-bold">Message</button>
                                    ) : (
                                        <button onClick={handleFollowBack} className="bg-blue-500 text-white px-4 py-1.5 rounded-lg text-sm font-bold">Follow</button>
                                    )
                                ) : (
                                    n.postImage && <img src={n.postImage} className="w-10 h-10 object-cover rounded" />
                                )}
                            </div>
                        </div>

                        {/* REPLY INPUT */}
                        {showReply && (
                            <form onSubmit={handleReply} className="mt-2 flex gap-2">
                                <input value={replyText} onChange={e=>setReplyText(e.target.value)} className="flex-1 border rounded px-3 py-1.5 text-xs outline-none bg-slate-50" placeholder="Reply..." autoFocus />
                                <button disabled={!replyText} className="text-blue-500 text-xs font-bold disabled:opacity-50">Post</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        }

        function NotificationsPage() {
            const [notifs, setNotifs] = React.useState([]);
            const [currentUser, setCurrentUser] = React.useState(null);
            
            React.useEffect(() => {
                onAuthStateChanged(auth, async u => {
                    if(!u) return window.location.href = "index.html";
                    
                    // --- SECURITY CHECK FOR NOTIFICATIONS ---
                    const myDoc = await getDoc(doc(db, "users", u.uid));
                    if (myDoc.exists() && myDoc.data().isBanned === true) {
                        await signOut(auth);
                        alert("Your account has been permanently disabled.");
                        window.location.href = "index.html";
                        return;
                    }
                    // ---------------------------------------

                    setCurrentUser(u);
                    const q = query(collection(db, "notifications"), where("to", "==", u.uid));
                    onSnapshot(q, snap => {
                        const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        data.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));
                        setNotifs(data);
                    });
                });
            }, []);

            if (!currentUser) return null;

            return (
                <div className="min-h-screen bg-white">
                    <Navbar />
                    <div className="max-w-md mx-auto p-4">
                        <h2 className="font-bold text-xl mb-4">Notifications</h2>
                        {notifs.length === 0 && <p className="text-slate-500 text-center mt-10">No new notifications.</p>}
                        
                        {notifs.map((n) => (
                            <NotificationItem key={n.id} n={n} currentUser={currentUser} />
                        ))}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NotificationsPage />);
    </script>
</body>
</html>